# CodeIgniter3 から CodeIgniter4 への移行記録

## 1. 事前準備(ロカール環境移行)
※AWSにNginx使用しているけど、ローカル環境では現在Apacheサーバ使用しています。今後Nginxに切り替える予定です。下記はApacheサーバの設定変更

1. 新規プロジェクト作成
   参考：https://codeigniter.com/user_guide/tutorial/index.html 
2. httpd_my.conf にCI4プロジェクトの設定追加
```bash
Alias /pl_api_ci4 /var/www/html/pl_api_ci4/public
<Directory "/var/www/html/pl_api_ci4/public">
    DirectoryIndex index.php
    Options Indexes FollowSymLinks
    AllowOverride All
    Require all granted
</Directory>
```
###変更内容を反映
```bash 
docker cp ./amazonlinux/httpd_my.conf link_web:/etc/httpd/conf.d/httpd_my.conf
```
###設定を反映
```bash
docker exec -it link_web systemctl restart httpd
```

3. .htaccess修正（cors対策）
```bash
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteBase /pl_api_ci4/

    # OPTIONS は処理しない
    RewriteCond %{REQUEST_METHOD} OPTIONS
    RewriteRule ^(.*)$ - [L]

    # 存在しないファイルは index.php へ
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^(.*)$ index.php/$1 [L]
</IfModule>

<IfModule mod_headers.c>
    Header always set Access-Control-Allow-Origin "*"
    Header always set Access-Control-Allow-Methods "GET,POST,OPTIONS,PUT,DELETE"
    Header always set Access-Control-Allow-Headers "Content-Type,Authorization"
</IfModule>
```
#設定を反映
```bash
systemctl restart httpd
```

---

## 2. 新規 CI4 プロジェクトの作成
- Docker コンテナ内で `composer` を使用して CI4 プロジェクトを新規作成  
  ※ ホスト環境が Ubuntu 20.04 のため、PHP 8.x に未対応 → CI4 の構築は不可  
  → **今後、ローカル開発環境の見直しを検討**

- PHP バージョン、nginx 設定を CI3 環境と揃える

- `Dockerfile` および `docker-compose.yml` を CI4 用に調整

---

## 3. 設定ファイル（Config/）の移行
- `application/config` 配下の各種設定を、`app/Config` の該当ファイルへ移行
- デフォルトの Config ファイルと、CI3 で独自に作成していた設定ファイルを CI4 側へ統合
- 環境変数の管理方法を変更  
  - CI3：設定ファイル内で個別に管理  
  - CI4：`.env` ファイルに集約
- 非推奨となった設定項目は、CI4 の新しい記述方法に合わせて修正
- CI3 で使用していた定数は、CI4 ではクラス内のプロパティとして再実装
- このプロジェクトはセッション出力不要と考えますので、出力しないように設定しました。もし、出力が必要の場合下記の設定を参考
  - CI4のデフォルトセッション設定：Config\Session.php → FileHandler設定されます。 そのため、セッション情報は サーバーの writable/session/ ディレクトリ にファイルとして保存されている。
  - 単一サーバー環境なら問題ないが、ロードバランサーで複数台（2台以上） の場合は以下の問題が発生する：
    - Aサーバーに保存されたセッションはBサーバーから参照できない
    - ログイン後にサーバー切り替えが起こると「ログインが切れる」「セッションが消える」といった不具合が発生する
    - 対応方法：セッションをDBに保存する（DBHandler）
    - DBHandlerの設定方法：https://codeigniter.com/user_guide/libraries/sessions.html#database-driver
    - サンプルデータベース
    ```sql
      CREATE TABLE `ci_sessions` (
      `id` varchar(128) NOT NULL,
      `ip_address` varchar(45) NOT NULL,
      `timestamp` int(10) unsigned DEFAULT 0 NOT NULL,
      `data` blob NOT NULL,
      PRIMARY KEY (`id`, `ip_address`)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
    ```

---
## 4. コア拡張・ライブラリ・ヘルパーの移行
1. Core直下
  - ディレクトリ名・ファイル名は大文字始まり、アンダースコアに合わせる。
  - クラス・名前空間追加
  - 継承や依存関係修正（例：CI3 では CI_Controller を継承していたが、CI4 では `CodeIgniter\Controller` を継承する必要がある）
  - 継承関連のドキュメント：https://codeigniter.com/user_guide/extending/core_classes.html
2. Libraries直下
  - ディレクトリ名・ファイル名は大文字始まり、アンダースコアに合わせる。
  - クラス・名前空間追加
3. Helpers直下
  - 名前空間を付けず、従来通り関数のみを定義
  - クラス型のライブラリやユーティリティはapp/Libraries/で名前空間を付けて管理します。
4. システム関連
　- CI4のsystem（フレームワーク本体）はvendor/codeigniter4/に配下
5. ThirdPartyライブラリインストール
※CI4では`app/ThirdParty/`: 手動配置は非推奨です。`vendor/: Composer`管理する。
  Composerでインストールしたパッケージはvendor/配下に配置します。
  - AWS SDK
    `composer require aws/aws-sdk-php`
  - Doctrine（ORM/DBAL）
    `composer require doctrine/orm`
    `composer require doctrine/dbal`
  - Symfony Components（必要に応じて選択）
    `composer require symfony/console`
    `composer require symfony/process`
    `composer require symfony/filesystem`
  - TCPDF（PDF生成）
    `composer require tecnickcom/tcpdf`
  - setasign（PDF関連ライブラリ）
    `composer require setasign/fpdf`
    `composer require setasign/fpdi`
  - chillerlan（QRコード等）
    `composer require chillerlan/php-qrcode`
  - JasperReports PHP Client（jaspersoft）
    `composer require jaspersoft/rest-client`
  - 開発・テスト用（--devフラグ付き）
    `composer require --dev phpunit/phpunit`
    `composer require --dev phpspec/phpspec`
6. Language/jaを移行
  - CI3 の `application/language/jp` を CI4 の `app/Language/ja` に移行
  - CodeIgniter4 の lang() 関数は 名前空間を使わず、単純にファイル名とキーを指定 する。
  - 名前空間が付いていると CI4 は言語配列として認識できず、文字列として返してしまいます。
  - CI4 の言語ファイルに合わせて修正

-   `composer.lockに基づいて依存関係をインストール

## 5. DAO・モデルの移行
1. DAOファイル移行　（一応完了）
  - CI3 の `application/models/dao` 配下のファイルを CI4 の `app/Models/Dao` 配下にそのまま移行
  - 名前空間を `App\Models\Dao` 追加
  - CI3 の DAO クラスは CI4 ではモデルとして扱うため、`Model` クラスを継承するように変更
  - CI4 のモデルでは、`$table` プロパティを定義する必要があるため、適宜追加
  - CI4に非推奨と削除されたメソッドは、CI4 の新しい記述方法に合わせて修正:
    ※https://codeigniter.com/user_guide/database/query_builder.html]

    - | CI3                                 | CI4 の代替                                             |
      | ------------------------            | --------------------------------------------------- |
      | `$query->num_rows()`                | `$query->getNumRows()` |
      | `$query->result_array()`            | `$query->getResultArray()`                          |
      | `$query->row();`                    | `$query->getRow();`                                |
      | `$query->result_object()/resutl();` | `$query->getResult();`                          |
      | `$this->db->delete('table', [...])` | `$this->db->table('table')->where([...])->delete()` |
      | `$this->db->insert_batch(...)`      | `$this->db->table('table')->insertBatch(...)`       |
      | `$this->db->get_where(...)`         | `$this->db->table('table')->where(...)->get()`      |
      | `$this->db->...(...)`               | `$this->builder->...()`                   |
      | `$this->db->trans_start();`         | `$this->db->transStart();`                   |
      | `$this->db->trans_commit();`        | `$this->db->transCommit();`                   |
      等...

2. モデルファイル移行
  - CI3 の `application/models` 配下のファイルを CI4 の `app/Models` 配下にそのまま移行
  - 名前空間を `App\Models` 追加
  - 必要に応じて `use App\Models\ModelName;`を追加
  - `$this->load->model('ModelName')` →　`$Variables =  new ModelName();`
  - `$this->ModelName->MethodName()` → `$Variables->MethodName()`
  - `$this->lang->line('line_key')` → `lang('line_key')`
  - その他 (※参考 : https://codeigniter.com/user_guide/models/model.html)

3. Controllerファイル移行
    - CI3 の `application/libraries/Validation` を CI4 の `app/Validation` に移行
    - 既存のバリデーションルールは問題があるので、CI4 のバリデーションルールに合わせて修正
    - 名前空間を `App\Controllers` 追加
    - CI4 のルーティングに合わせて修正

3.1. PaasのControllerファイル移行
　  - CI3 の `application/controllers/Paas` を CI4 の `app/Controllers/Paas` に移行
　  - 名前空間を `App\Controllers\Paas` 追加
　  - CI4 のルーティングに合わせて修正

4. Routes 再確認

## デバックのメモー(WEB)

1. レスポンス返却する時`return`を追加、追加しないとHTTP レスポンスがブラウザに送られない。
- 例：`$this->set_response_success($respons_obj); → return $this->respond($respons_obj);`
2. レガシーコードは不要な処理や潜在的なバグがすごく多いので、CI4 の新しい記述方法に合わせてリファクタリングする。
3. デバックバーとセッション設定（ファイル出力等再確認が必要）
4. ログファイルの出力フォーマット修正。（リクエストログのデフォルトはパラメータ内容含まず、カスタム対応が必要でした。）
5. `$method = $this->req_method`
   `$this->valid->required($this->$method('login_id'), 'ログインID');`
   を使えないですので、下記のように修正。※他のパラメータも同様
	`$this->valid->required($this->requestBody['login_id'], 'ログインID');`

6. nullは許容されないので、すべてのパラメータにnullチェックを追加
7. オブジェクトと配列のデータ型は厳密に区別する必要があります。（キャスト追加またオブジェクトと配列の変換が必要）
8. CI3の`defined('BASEPATH') or exit('No direct script access allowed');`を削除
  - 削除しないと「No direct script access allowed」とエラーが発生する。

9. return $this->db->compile_binds() →　$query = $this->db->query($sql, $condition_param);
			                                  return $lastQuery = (string) $this->db->getLastQuery();
  ※CI4ではcompile_binds()は廃止されました。String型維持するため、キャストを追加
10. QRコード生成
 - CI3の`$options->outputInterface = QRGdImagePNG::class;`使えないですので
  `'outputType' => QRCode::OUTPUT_IMAGE_PNG,`に修正

11. S3連携
- 一時的のファイル保存ディレクトリのpath設定は APPATHではなく WRITEPATH を使用する
- writableにtempファイル作成が必要です。
```bash
mkdir -p temp
# 書き込み権限を付与( localに777不要したけど、本番は775推奨）
chmod -R 777 temp
```
12. PDF
- CI3の`$pdfData = $pdf->Output($file_name, 'I');`は使えないですので
  ```php 
  $pdfData = $pdf->Output($file_name, 'I');
  // レスポンスとして返却（Content-Type自動付与）
  return $this->response
              ->setContentType('application/pdf')
              ->setHeader('Content-Disposition', 'inline; filename="' . $file_name . '"')
              ->setBody($pdfData);`
```に修正
```

## デバックのメモー(モバイルアプリ)
1.  
`$this->response->format = 'xml';` から `$this->rest_format = 'xml';`に修正
`$this->response->format = 'json';` から `$this->rest_format = 'json';`に修正
2. JSON形式リクエストデータ取得 `$method = $this->req_method;` を使えないですので「$data = $this->get_input_data();」を使ってリクエストデータ設定。
3. データベース関連
- CI3でオブジェクトのプロパティをforeachでループで、定義されていないプロパティ（null値）は自動的にスキップされていました。しかし、CI4では#[\AllowDynamicProperties]が有効でも、未定義プロパティが空の値として扱われることがあるため、実際データベースにカラムが存在しないとエラーが発生されます。
- 対応方法： テーブルに存在するフィールドのみを定義
