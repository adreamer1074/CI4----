# CodeIgniter3 から CodeIgniter4 への移行記録

## 1. 事前準備（完了）
- 現行 CI3 アプリの **全バックアップ** を取得  
  - コード
  - データベース
  - 設定ファイル
  - Docker 関連ファイル一式

---

## 2. 新規 CI4 プロジェクトの作成（完了）
- Docker コンテナ内で `composer` を使用して CI4 プロジェクトを新規作成  
  ※ ホスト環境が Ubuntu 20.04 のため、PHP 8.x に未対応 → CI4 の構築は不可  
  → **今後、ローカル開発環境の見直しを検討**

- PHP バージョン、nginx 設定を CI3 環境と揃える

- `Dockerfile` および `docker-compose.yml` を CI4 用に調整

---

## 3. 設定ファイル（Config/）の移行（完了。リファクタリング予定）
- `application/config` 配下の各種設定を、`app/Config` の該当ファイルへ移行

- デフォルトの Config ファイルと、CI3 で独自に作成していた設定ファイルを CI4 側へ統合

- 環境変数の管理方法を変更  
  - CI3：設定ファイル内で個別に管理  
  - CI4：`.env` ファイルに集約

- 非推奨となった設定項目は、CI4 の新しい記述方法に合わせて修正

- CI3 で使用していた定数は、CI4 ではクラス内のプロパティとして再実装

---
## 4. コア拡張・ライブラリ・ヘルパーの移行（完了。リファクタリング予定）
1. Core直下
  - ディレクトリ名・ファイル名は大文字始まり、アンダースコアに合わせる。
  - クラス・名前空間追加
  - 継承や依存関係修正（例：CI3 では CI_Controller を継承していたが、CI4 では `CodeIgniter\Controller` を継承する必要がある）
  - 継承関連のドキュメント：https://codeigniter.com/user_guide/extending/core_classes.html
2. Libraries直下
  - ディレクトリ名・ファイル名は大文字始まり、アンダースコアに合わせる。
  - クラス・名前空間追加
3. Helpers直下
  - 名前空間を付けず、従来通り関数のみを定義
  - クラス型のライブラリやユーティリティはapp/Libraries/で名前空間を付けて管理します。
4. システム関連
　- CI4のsystem（フレームワーク本体）はvendor/codeigniter4/に配下
5. ThirdPartyライブラリインストール
※CI4では`app/ThirdParty/`: 手動配置は非推奨です。`vendor/: Composer`管理する。
  Composerでインストールしたパッケージはvendor/配下に配置します。
  - AWS SDK
    `composer require aws/aws-sdk-php`
  - Doctrine（ORM/DBAL）
    `composer require doctrine/orm`
    `composer require doctrine/dbal`
  - Symfony Components（必要に応じて選択）
    `composer require symfony/console`
    `composer require symfony/process`
    `composer require symfony/filesystem`
  - TCPDF（PDF生成）
    `composer require tecnickcom/tcpdf`
  - setasign（PDF関連ライブラリ）
    `composer require setasign/fpdf`
    `composer require setasign/fpdi`
  - chillerlan（QRコード等）
    `composer require chillerlan/php-qrcode`
  - JasperReports PHP Client（jaspersoft）
    `composer require jaspersoft/rest-client`
  - 開発・テスト用（--devフラグ付き）
    `composer require --dev phpunit/phpunit`
    `composer require --dev phpspec/phpspec`
    `composer require --dev phpdocumentor/phpdocumentor`
    `composer require --dev sebastian/phpcpd`
6. Language/jaを移行
  - CI3 の `application/language/ja` を CI4 の `app/Language/ja` に移行
  - 名前空間を `App\Language\ja` 追加
  - CI4 の言語ファイルに合わせて修正

-   `composer.lockに基づいて依存関係をインストール

## 5. DAO・モデルの移行（進行中）
1. DAOファイル移行　（一応完了）
  - CI3 の `application/models/dao` 配下のファイルを CI4 の `app/Models/Dao` 配下にそのまま移行
  - 名前空間を `App\Models\Dao` 追加
  - CI3 の DAO クラスは CI4 ではモデルとして扱うため、`Model` クラスを継承するように変更
  - CI4 のモデルでは、`$table` プロパティを定義する必要があるため、適宜追加
  - CI4に非推奨と削除されたメソッドは、CI4 の新しい記述方法に合わせて修正:
    ※https://codeigniter.com/user_guide/database/query_builder.html
    - | CI3                                 | CI4 の代替                                             |
      | ------------------------            | --------------------------------------------------- |
      | `$query->num_rows()`                | `$query->getNumRows()` |
      | `$query->result_array()`            | `$query->getResultArray()`                          |
      | `$query->row();`                    | `$query->getRow();`                                |
      | `$query->result_object()/resutl();` | `$query->getResult();`                          |
      | `$this->db->delete('table', [...])` | `$this->db->table('table')->where([...])->delete()` |
      | `$this->db->insert_batch(...)`      | `$this->db->table('table')->insertBatch(...)`       |
      | `$this->db->get_where(...)`         | `$this->db->table('table')->where(...)->get()`      |
      | `$this->db->...(...)`               | `$this->builder->...()`                   |
      | `$this->db->trans_start();`         | `$this->db->transStart();`                   |
      | `$this->db->trans_commit();`        | `$this->db->transCommit();`                   |
      等...

2. モデルファイル移行
  - CI3 の `application/models` 配下のファイルを CI4 の `app/Models` 配下にそのまま移行
  - 名前空間を `App\Models` 追加
  - 必要に応じて `use App\Models\ModelName;`を追加
  - `$this->load->model('ModelName')` →　`$Variables =  new ModelName();`
  - `$this->ModelName->MethodName()` → `$Variables->MethodName()`
  - `$this->lang->line('line_key')` → `lang('line_key')`
  - その他 (※参考 : https://codeigniter.com/user_guide/models/model.html)
3. Controllerファイル移行
    - CI3 の `application/libraries/Validation` を CI4 の `app/Validation` に移行
    - 既存のバリデーションルールは問題があるので、CI4 のバリデーションルールに合わせて修正
    - 名前空間を `App\Controllers` 追加
    - CI4 のルーティングに合わせて修正
3.1. PaasのControllerファイル移行
　  - CI3 の `application/controllers/Paas` を CI4 の `app/Controllers/Paas` に移行
　  - 名前空間を `App\Controllers\Paas` 追加
　  - CI4 のルーティングに合わせて修正