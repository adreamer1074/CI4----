# CI3→CI4 本番移行計画書

## 概要
**新EC2インスタンス方式**
- 現在環境（CI3）: そのまま稼働継続（バックアップとして保持）
- 新環境（CI4）: 新EC2インスタンスで構築・テスト
- ALB: ターゲットグループで新EC2に切り替え

## 移行手順

### Phase 1: 新EC2環境構築

#### 1-1. 新EC2インスタンス作成
```bash
# 現在のマスターAMIから新EC2インスタンス起動
# インスタンスタイプ: 現在と同等またはそれ以上
# セキュリティグループ: 現在のAPサーバと同じ設定
# サブネット: 同じプライベートサブネット
# ホスト名設定
sudo hostnamectl set-hostname callweb-ci4-01
```

#### 1-2. Docker環境セットアップ
```bash
# 新EC2にSSH接続
ssh -i key.pem ec2-user@<新EC2のプライベートIP>

# Docker/Docker Compose設定
sudo dnf update
sudo dnf install -y docker
sudo systemctl start docker
sudo systemctl enable docker
```

#### 1-3. CI4プロジェクト配置
```bash
# pl_api_ci4フォルダを新EC2にアップロード
# CI4用のDocker設定ファイル作成
# app/Config/Database.php設定
# nginx設定をCI4用に調整
```

### Phase 2: 本番移行実行

#### 2-1. ALBターゲット変更準備
```bash
# 新EC2でCI4コンテナ起動
cd /path/to/pl_api_ci4
sudo docker-compose up -d

# 起動確認・動作テスト
sudo docker ps
curl -X POST http://localhost:8081/auth/login
```

#### 2-2. ALBターゲット切り替え（停止時間開始）
```bash
# AWS マネジメントコンソールで実行：
# 1. ターゲットグループに新EC2を追加
# 2. ヘルスチェック: Healthy 確認
# 3. 現在のCI3 EC2を登録解除
# 4. ステータス: Draining → Unused 確認
```

#### 2-3. 動作確認（停止時間終了）
```bash
# 外部からのAPI疎通確認
# 踏み台サーバーからのテスト
# 実際のクライアントアプリからの確認
# ログエラー確認
```

### Phase 3: 移行完了確認

#### 3-1. 外部疎通確認
```bash
# 踏み台サーバーからの疎通確認
# 実際のクライアントアプリからのテスト
# 全APIエンドポイントの動作確認
```

#### 3-2. 監視・ログ確認
```bash
# CloudWatch メトリクス確認
# エラーログ監視
# データベース接続確認
```


### ロールバック手順

```bash
# 問題発生時の即座復旧（3-5分以内）
# AWS マネジメントコンソールで実行：

1. EC2 > ターゲットグループを選択
2. CI3 EC2インスタンスを「ターゲットの登録」
3. CI4 EC2インスタンスを「登録解除」
4. ヘルスチェック: CI3が Healthy になるまで待機
5. 完了！

# それだけです - コンテナ操作や設定変更は一切不要
# CI3環境は移行後もそのまま稼働状態で保持されているため
```
